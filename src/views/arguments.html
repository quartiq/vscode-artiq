<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Arguments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="{TABULATOR_STYLES_URI}" rel="stylesheet">
    <link href="{CUSTOM_STYLES_URI}" rel="stylesheet">
    <script type="text/javascript" src="{TABULATOR_SCRIPT_URI}"></script>

    <style>
        .hidden { display: none }
    </style>
</head>

<body>
    <div class="idle hidden">
        <p class="msg">No arguments available.</p>
    </div>

    <div class="table"></div>

    <script type="module">
        // TODO: Add missing input "Scannable"
        import {entry} from "{SHARED_URI}/entries.js";
        const vscode = acquireVsCodeApi();
        let table;

        let editor = (cell, onRendered, success, cancel) => {
            let procdesc = cell.getRow().getData().procdesc;
            return entry(procdesc.ty)?.editor({procdesc, cell, onRendered, success, cancel, post: vscode.postMessage});
        };

        let cellEdited = cell => {
            let raw = cell.getRow().getData();
            vscode.postMessage({
                action: "change", data: {
                    name: raw.name,
                    arg: [raw.procdesc, raw.group, raw.tooltip, raw.state],
                },
            });
        };

        let updateTable = arginfo => {
            let data = Object.entries(arginfo)
                .map(([name, arg]) => ({ name, procdesc: arg[0], group: arg[1], tooltip: arg[2], state: arg[3] }));

            table?.destroy?.();
            table = new Tabulator(".table", {
                headerVisible: false,
                layout: "fitDataFill",
                data,
                groupBy: "group",
                groupHeader: value => value ?? "",
                columns: [
                    { field: "name" },
                    { field: "state", editor, cellEdited },
                ],
                columnDefaults: { tooltip: (ev, cell) => cell.getRow().getData().tooltip },
            });
        };

        let idleel = document.querySelector(".idle");
        let tableel = document.querySelector(".table");

        let actions = {
            update: data => {
                if (!data.arginfo) {
                    idleel.classList.remove("hidden");
                    tableel.classList.add("hidden");
                    return;
                }

                updateTable(data.arginfo);
                idleel.classList.add("hidden");
                tableel.classList.remove("hidden");
            },
        };

        window.addEventListener("message", ev => actions[ev.data.action](ev.data.data));
    </script>
</body>

</html>