<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Arguments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="{TABULATOR_STYLES_URI}" rel="stylesheet">
    <script type="text/javascript" src="{TABULATOR_SCRIPT_URI}"></script>

    <style>
        .hidden { display: none }
    </style>
</head>

<body>
    <div class="idle hidden">
        <p class="msg">No arguments available.</p>
    </div>

    <div class="table"></div>

    <script type="module">
        // TODO: Add missing input "Scannable"
        import {entry} from "{SHARED_URI}/entries.js";
        const vscode = acquireVsCodeApi();
        let table;

        let buttonsEditor = (cell, onRendered, success, cancel) => {
            let procdesc = cell.getRow().getData().procdesc;
            let el = document.createElement("div");

            procdesc.choices.forEach(c => {
                let cel = document.createElement("input");
                cel.setAttribute("type", "button");
                cel.setAttribute("value", c);
                cel.addEventListener("click", ev => {
                    success(c);
                    vscode.postMessage( {action: "submit"} );
                });
                el.append(cel);
            });

            onRendered(() => el.focus());
            el.addEventListener("keydown", ev => ev.key === "Escape" && cancel());

            return el;
        };

        let selectEditor = (cell, onRendered, success, cancel) => {
            let procdesc = cell.getRow().getData().procdesc;
            let el = document.createElement("select");
            el.value = cell.getValue();

            procdesc.choices.forEach(c => {
                let cel = document.createElement("option");
                cel.textContent = c;
                cel.setAttribute("value", c);
                el.append(cel);
            });

            onRendered(() => el.focus());
            el.addEventListener("change", () => success(parseInput(el)));
            el.addEventListener("keydown", ev => ev.key === "Escape" && cancel());

            return el;
        };

        let inputEditor = (cell, onRendered, success, cancel) => {
            let procdesc = cell.getRow().getData().procdesc;
            let el = document.createElement("input");
            let parse = entry(procdesc.ty)?.parseInput;
            el.value = cell.getValue();
            entry(procdesc.ty)?.setAttributes(el, procdesc);

            onRendered(() => el.focus());
            el.addEventListener("blur", () => success(parse(el)));
            el.addEventListener("keydown", ev => {
                if (ev.key === "Enter") success(parse(el));
                if (ev.key === "Escape") cancel();
            });

            return el;
        };

        let editor = (cell, onRendered, success, cancel) => {
            let procdesc = cell.getRow().getData().procdesc;
            if (procdesc.ty !== "EnumerationValue") { return inputEditor(cell, onRendered, success, cancel); }
            if (!procdesc.quickstyle) { return selectEditor(cell, onRendered, success, cancel); }
            return buttonsEditor(cell, onRendered, success, cancel);
        };

        let cellEdited = cell => {
            let raw = cell.getRow().getData();
            vscode.postMessage({
                action: "change", data: {
                    name: raw.name,
                    arg: [raw.procdesc, raw.group, raw.tooltip, raw.state],
                },
            });
        };

        let updateTable = arginfo => {
            let data = Object.entries(arginfo)
                .map(([name, arg]) => ({ name, procdesc: arg[0], group: arg[1], tooltip: arg[2], state: arg[3] }));

            table?.destroy?.();
            table = new Tabulator(".table", {
                headerVisible: false,
                layout: "fitDataStretch",
                data,
                groupBy: "group",
                groupHeader: value => value ?? "",
                columns: [
                    { field: "name" },
                    { field: "state", editor, cellEdited },
                ],
                columnDefaults: { tooltip: (ev, cell) => cell.getRow().getData().tooltip },
            });
        };

        let idleel = document.querySelector(".idle");
        let tableel = document.querySelector(".table");

        let actions = {
            update: data => {
                if (!data.arginfo) {
                    idleel.classList.remove("hidden");
                    tableel.classList.add("hidden");
                    return;
                }

                updateTable(data.arginfo);
                idleel.classList.add("hidden");
                tableel.classList.remove("hidden");
            },
        };

        window.addEventListener("message", ev => actions[ev.data.action](ev.data.data));
    </script>
</body>

</html>